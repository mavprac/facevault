<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="FaceVault" />
<meta name="theme-color" content="#0a0a0f" />
<title>FaceVault</title>
<link rel="manifest" href="manifest.json" />
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png" />
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet" />
<style>
:root {
  --bg: #0a0a0f;
  --surface: #13131a;
  --surface2: #1c1c28;
  --border: #2a2a3d;
  --gold: #c9a84c;
  --gold-light: #e8c97a;
  --gold-dim: rgba(201,168,76,0.15);
  --text: #e8e6de;
  --text-dim: #7a7870;
  --green: #4caf82;
  --red: #cf6679;
  --blue: #5b8dee;
  --radius: 14px;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; overscroll-behavior: none; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'DM Mono', monospace;
  min-height: 100vh; min-height: 100dvh;
  overflow-x: hidden;
  user-select: none; -webkit-user-select: none;
}

/* Grain overlay */
body::before {
  content: '';
  position: fixed; inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
  background-size: 200px;
  pointer-events: none; z-index: 9999; opacity: 0.4;
}

/* â”€â”€ Layout â”€â”€ */
.app-shell { display: flex; flex-direction: column; height: 100vh; height: 100dvh; }

header {
  padding: 12px 20px;
  padding-top: calc(12px + var(--safe-top));
  background: rgba(10,10,15,0.95);
  backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  flex-shrink: 0; z-index: 100;
}

.logo { font-family: 'Cormorant Garamond', serif; font-size: 22px; font-weight: 600; letter-spacing: 0.05em; color: var(--gold); }
.logo span { color: var(--text-dim); font-weight: 300; }

.status-pill { display: flex; align-items: center; gap: 7px; font-size: 10px; letter-spacing: 0.1em; color: var(--text-dim); text-transform: uppercase; }
.status-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--text-dim); transition: background 0.3s; }
.status-dot.ready  { background: var(--green); box-shadow: 0 0 8px var(--green); }
.status-dot.loading { background: var(--gold); box-shadow: 0 0 8px var(--gold); animation: pulse 1s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

.content {
  flex: 1; overflow-y: auto; overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  padding: 20px 16px;
  padding-bottom: calc(80px + var(--safe-bottom));
}

/* â”€â”€ Bottom nav â”€â”€ */
.bottom-nav {
  position: fixed; bottom: 0; left: 0; right: 0;
  padding-bottom: var(--safe-bottom);
  background: rgba(13,13,20,0.97);
  backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  border-top: 1px solid var(--border);
  display: flex; z-index: 200;
}
.bottom-nav-btn {
  flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 5px; padding: 10px 4px 12px;
  background: transparent; border: none; cursor: pointer;
  color: var(--text-dim); transition: color 0.2s;
  min-height: 60px;
}
.bottom-nav-btn svg { width: 22px; height: 22px; transition: transform 0.2s; }
.bottom-nav-btn span { font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: 0.1em; text-transform: uppercase; }
.bottom-nav-btn.active { color: var(--gold); }
.bottom-nav-btn.active svg { transform: translateY(-2px); filter: drop-shadow(0 0 6px var(--gold)); }

/* â”€â”€ Panel â”€â”€ */
.panel { display: none; }
.panel.active { display: block; animation: fadeUp 0.25s ease; }
@keyframes fadeUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

.panel-title { font-family: 'Cormorant Garamond', serif; font-size: 28px; font-weight: 300; margin-bottom: 4px; }
.panel-sub { font-size: 10px; color: var(--text-dim); letter-spacing: 0.06em; margin-bottom: 20px; text-transform: uppercase; }

/* â”€â”€ Mode tabs â”€â”€ */
.mode-tabs { display: flex; border: 1px solid var(--border); border-radius: 10px; overflow: hidden; background: var(--surface2); margin-bottom: 16px; }
.mode-tab {
  flex: 1; padding: 11px 8px;
  font-family: 'DM Mono', monospace; font-size: 11px; letter-spacing: 0.08em;
  text-transform: uppercase; cursor: pointer; border: none; background: transparent;
  color: var(--text-dim); transition: all 0.2s;
  display: flex; align-items: center; justify-content: center; gap: 7px;
}
.mode-tab:first-child { border-right: 1px solid var(--border); }
.mode-tab.active { background: var(--gold-dim); color: var(--gold); }
.mode-tab svg { width: 14px; height: 14px; flex-shrink: 0; }

/* â”€â”€ Camera â”€â”€ */
.camera-wrap {
  position: relative; width: 100%;
  border-radius: var(--radius); overflow: hidden;
  border: 1px solid var(--border); background: var(--surface);
  aspect-ratio: 3/4; max-height: 55vh;
}
video, canvas.preview { width: 100%; height: 100%; object-fit: cover; display: block; }
canvas.preview { position: absolute; top: 0; left: 0; }

.camera-overlay {
  position: absolute; inset: 0; pointer-events: none;
  border: 2px solid transparent; border-radius: var(--radius); transition: border-color 0.3s;
}
.camera-overlay.detected { border-color: var(--gold); box-shadow: inset 0 0 40px rgba(201,168,76,0.1); }

.camera-wrap::before, .camera-wrap::after {
  content: ''; position: absolute; width: 18px; height: 18px;
  border-color: var(--gold); border-style: solid; z-index: 10; opacity: 0.6;
}
.camera-wrap::before { top: 10px; left: 10px; border-width: 2px 0 0 2px; }
.camera-wrap::after  { bottom: 10px; right: 10px; border-width: 0 2px 2px 0; }

.face-badge {
  position: absolute; top: 10px; right: 10px;
  background: rgba(10,10,15,0.85); border: 1px solid var(--gold); border-radius: 4px;
  padding: 4px 10px; font-size: 10px; letter-spacing: 0.1em;
  color: var(--gold); text-transform: uppercase; z-index: 20; opacity: 0; transition: opacity 0.3s;
}
.face-badge.visible { opacity: 1; }

.cam-flip {
  position: absolute; bottom: 12px; right: 12px; z-index: 30;
  background: rgba(10,10,15,0.7); border: 1px solid var(--border);
  border-radius: 50%; width: 40px; height: 40px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; color: var(--text); transition: background 0.2s;
}
.cam-flip:hover { background: rgba(201,168,76,0.2); }
.cam-flip svg { width: 18px; height: 18px; }

/* â”€â”€ Controls â”€â”€ */
.controls { display: flex; gap: 10px; justify-content: center; margin-top: 14px; flex-wrap: wrap; }

.btn {
  padding: 13px 24px; border-radius: 10px;
  font-family: 'DM Mono', monospace; font-size: 12px;
  letter-spacing: 0.08em; text-transform: uppercase;
  cursor: pointer; border: none; transition: all 0.18s;
  min-height: 48px;
}
.btn-primary { background: var(--gold); color: #0a0a0f; font-weight: 500; }
.btn-primary:active { background: var(--gold-light); transform: scale(0.97); }
.btn-primary:disabled { opacity: 0.35; pointer-events: none; }
.btn-ghost { background: transparent; color: var(--text-dim); border: 1px solid var(--border); }
.btn-ghost:active { background: var(--surface2); }
.btn-blue { background: rgba(91,141,238,0.15); color: var(--blue); border: 1px solid rgba(91,141,238,0.3); }
.btn-blue:active { background: rgba(91,141,238,0.25); }

/* â”€â”€ Multi-photo capture strip â”€â”€ */
.photo-strip-label {
  font-size: 10px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-dim);
  margin-top: 16px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between;
}
.photo-strip-label .strip-hint { font-size: 9px; color: var(--text-dim); opacity: 0.6; }
.photo-strip {
  display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px;
  scrollbar-width: none;
}
.photo-strip::-webkit-scrollbar { display: none; }
.strip-slot {
  flex-shrink: 0; width: 70px; height: 70px; border-radius: 8px;
  border: 1.5px dashed var(--border); background: var(--surface);
  display: flex; align-items: center; justify-content: center;
  position: relative; overflow: hidden; transition: border-color 0.2s;
}
.strip-slot.filled { border-color: var(--gold); border-style: solid; }
.strip-slot img { width: 100%; height: 100%; object-fit: cover; }
.strip-slot .slot-num {
  font-size: 18px; color: var(--border);
}
.strip-slot .slot-del {
  position: absolute; top: 2px; right: 2px;
  background: rgba(10,10,15,0.8); border: none; color: var(--red);
  border-radius: 3px; width: 18px; height: 18px; font-size: 10px;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  z-index: 5;
}
.strip-progress {
  font-size: 10px; color: var(--gold); margin-top: 6px; letter-spacing: 0.05em;
}

/* â”€â”€ Upload zone â”€â”€ */
.upload-zone {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  width: 100%; aspect-ratio: 3/4; max-height: 55vh;
  border: 2px dashed var(--border); border-radius: var(--radius);
  background: var(--surface); cursor: pointer;
  transition: border-color 0.2s, background 0.2s;
  position: relative; overflow: hidden;
}
.upload-zone:active, .upload-zone.drag-over { border-color: var(--gold); background: var(--gold-dim); }
.upload-zone input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; z-index: 10; }
.upload-icon { font-size: 44px; margin-bottom: 14px; opacity: 0.35; }
.upload-label { font-size: 12px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-dim); }
.upload-sublabel { font-size: 10px; color: var(--text-dim); opacity: 0.5; margin-top: 6px; text-align: center; padding: 0 20px; }
.upload-preview { position: absolute; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; }
.upload-preview.show { display: flex; }
.upload-preview img { width: 100%; height: 100%; object-fit: cover; }
.upload-preview-overlay { position: absolute; inset: 0; background: rgba(10,10,15,0.45); display: flex; align-items: flex-end; padding: 14px; }
.upload-preview-label { font-size: 11px; color: var(--text); background: rgba(10,10,15,0.8); padding: 5px 12px; border-radius: 6px; border: 1px solid var(--border); max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* â”€â”€ Name input â”€â”€ */
.input-wrap { display: flex; gap: 10px; margin-top: 14px; }
input[type=text] {
  flex: 1; background: var(--surface2); border: 1px solid var(--border); border-radius: 10px;
  color: var(--text); font-family: 'DM Mono', monospace; font-size: 14px;
  padding: 13px 16px; outline: none; transition: border-color 0.2s; min-height: 48px;
}
input[type=text]:focus { border-color: var(--gold); }
input[type=text]::placeholder { color: var(--text-dim); }

/* â”€â”€ Duplicate warning â”€â”€ */
.duplicate-warn {
  margin-top: 10px; padding: 10px 14px; border-radius: 8px;
  border: 1px solid rgba(201,168,76,0.4); background: rgba(201,168,76,0.08);
  font-size: 11px; color: var(--gold); letter-spacing: 0.04em; display: none;
  animation: fadeUp 0.2s ease;
}
.duplicate-warn.show { display: block; }
.duplicate-warn strong { color: var(--gold-light); }

/* â”€â”€ Result card â”€â”€ */
.result-card {
  margin-top: 18px; border-radius: var(--radius);
  border: 1px solid var(--border); background: var(--surface); overflow: hidden; display: none;
  animation: fadeUp 0.3s ease;
}
.result-card.show { display: block; }
.result-header { padding: 11px 18px; background: var(--surface2); border-bottom: 1px solid var(--border); font-size: 10px; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-dim); }
.result-body { display: flex; align-items: center; gap: 16px; padding: 16px; }
.result-photo { width: 72px; height: 72px; border-radius: 10px; object-fit: cover; border: 2px solid var(--gold); flex-shrink: 0; }
.result-info h2 { font-family: 'Cormorant Garamond', serif; font-size: 24px; font-weight: 600; }
.result-info p  { color: var(--text-dim); font-size: 10px; margin-top: 4px; line-height: 1.5; }

/* Distance meter */
.distance-meter { margin-top: 10px; }
.distance-meter-label { font-size: 9px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-dim); margin-bottom: 5px; display: flex; justify-content: space-between; }
.distance-bar-track { height: 4px; background: var(--surface2); border-radius: 2px; overflow: hidden; }
.distance-bar-fill { height: 100%; border-radius: 2px; transition: width 0.5s ease; }

.match-score {
  display: inline-block; margin-top: 8px; padding: 3px 10px; border-radius: 4px;
  font-size: 10px; letter-spacing: 0.1em; text-transform: uppercase;
}
.match-score.high { background: rgba(76,175,130,0.15); color: var(--green); border: 1px solid var(--green); }
.match-score.low  { background: rgba(201,168,76,0.15);  color: var(--gold);  border: 1px solid var(--gold);  }
.match-score.none { background: rgba(207,102,121,0.15); color: var(--red);   border: 1px solid var(--red);   }

/* â”€â”€ Gallery â”€â”€ */
.gallery-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
.gallery-title { font-family: 'Cormorant Garamond', serif; font-size: 28px; font-weight: 300; }
.gallery-controls { display: flex; align-items: center; gap: 10px; }
.count-badge { font-size: 11px; color: var(--text-dim); }
.btn-sm {
  padding: 7px 14px; font-size: 10px; border-radius: 8px;
  font-family: 'DM Mono', monospace; letter-spacing: 0.08em; text-transform: uppercase;
  cursor: pointer; border: 1px solid var(--red); background: transparent; color: var(--red);
  transition: all 0.2s; min-height: 36px;
}
.btn-sm:active { background: rgba(207,102,121,0.15); }

.gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
.gallery-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; transition: border-color 0.2s; position: relative; }
.gallery-card:active { border-color: var(--gold); }
.gallery-card img { width: 100%; aspect-ratio: 1; object-fit: cover; display: block; }
.gallery-card-del { position: absolute; top: 7px; right: 7px; background: rgba(10,10,15,0.75); border: none; border-radius: 4px; color: var(--red); cursor: pointer; padding: 5px 7px; font-size: 13px; min-height: 32px; min-width: 32px; }
.gallery-card-info { padding: 10px; border-top: 1px solid var(--border); }
.gallery-card-name { font-family: 'Cormorant Garamond', serif; font-size: 15px; font-weight: 600; }
.gallery-card-date { font-size: 9px; color: var(--text-dim); margin-top: 2px; }
.gallery-card-shots { font-size: 9px; color: var(--blue); margin-top: 3px; letter-spacing: 0.04em; }

.empty-state { text-align: center; padding: 60px 24px; color: var(--text-dim); grid-column: 1/-1; }
.empty-state .icon { font-size: 44px; margin-bottom: 14px; opacity: 0.35; }
.empty-state p { font-size: 12px; line-height: 1.8; }

/* â”€â”€ Notes input â”€â”€ */
.notes-wrap { margin-top: 10px; }
textarea.notes-input {
  width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 10px;
  color: var(--text); font-family: 'DM Mono', monospace; font-size: 12px;
  padding: 11px 16px; outline: none; transition: border-color 0.2s; resize: none;
  height: 64px; line-height: 1.6; letter-spacing: 0.03em;
}
textarea.notes-input:focus { border-color: var(--gold); }
textarea.notes-input::placeholder { color: var(--text-dim); }

/* â”€â”€ Capture quality indicator â”€â”€ */
.capture-quality {
  margin-top: 6px; font-size: 10px; letter-spacing: 0.06em;
  text-transform: uppercase; display: flex; align-items: center; gap: 7px;
  min-height: 18px;
}
.quality-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.quality-dot.good  { background: var(--green); box-shadow: 0 0 6px var(--green); }
.quality-dot.ok    { background: var(--gold);  box-shadow: 0 0 6px var(--gold);  }
.quality-dot.bad   { background: var(--red);   box-shadow: 0 0 6px var(--red);   }

/* â”€â”€ Export/Import â”€â”€ */
.vault-actions { display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap; }
.btn-icon {
  display: flex; align-items: center; gap: 7px;
  padding: 9px 16px; border-radius: 9px; font-size: 11px;
  font-family: 'DM Mono', monospace; letter-spacing: 0.07em; text-transform: uppercase;
  cursor: pointer; border: 1px solid var(--border); background: transparent;
  color: var(--text-dim); transition: all 0.2s; min-height: 40px;
}
.btn-icon:active { background: var(--surface2); color: var(--text); }
.btn-icon svg { width: 14px; height: 14px; flex-shrink: 0; }

/* â”€â”€ Multi-frame scanning indicator â”€â”€ */
.scan-progress {
  display: none; margin-top: 12px; padding: 12px 16px;
  background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
}
.scan-progress.show { display: block; }
.scan-label { font-size: 10px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-dim); margin-bottom: 8px; }
.scan-dots { display: flex; gap: 8px; }
.scan-dot {
  width: 10px; height: 10px; border-radius: 50%;
  background: var(--border); transition: background 0.3s, box-shadow 0.3s;
}
.scan-dot.active { background: var(--gold); box-shadow: 0 0 8px var(--gold); }
.scan-dot.done   { background: var(--green); box-shadow: 0 0 6px var(--green); }

/* â”€â”€ Closest no-match hint â”€â”€ */
.closest-hint {
  margin-top: 10px; padding: 10px 14px; border-radius: 8px;
  border: 1px solid var(--border); background: var(--surface2);
  font-size: 11px; color: var(--text-dim); letter-spacing: 0.04em; display: none;
}
.closest-hint.show { display: block; }
.closest-hint strong { color: var(--text); }

/* â”€â”€ DB badge â”€â”€ */
.db-badge {
  display: inline-flex; align-items: center; gap: 8px;
  padding: 9px 14px; border-radius: 8px;
  border: 1px solid rgba(76,175,130,0.25); background: rgba(76,175,130,0.05);
  font-size: 10px; color: var(--text-dim); letter-spacing: 0.04em; margin-bottom: 16px; width: 100%;
}
.db-badge::before { content: ''; width: 7px; height: 7px; border-radius: 50%; background: var(--green); box-shadow: 0 0 6px var(--green); flex-shrink: 0; }
.db-badge strong { color: var(--green); }

/* â”€â”€ Toast â”€â”€ */
.toast {
  position: fixed; bottom: calc(70px + var(--safe-bottom) + 8px); left: 16px; right: 16px;
  background: var(--surface2); border: 1px solid var(--border); border-radius: 10px;
  padding: 12px 18px; font-size: 12px; letter-spacing: 0.05em;
  z-index: 9000; text-align: center;
  transform: translateY(20px); opacity: 0;
  transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1), opacity 0.3s;
  pointer-events: none;
}
.toast.show { transform: translateY(0); opacity: 1; }
.toast.success { border-color: var(--green); color: var(--green); }
.toast.error   { border-color: var(--red);   color: var(--red);   }
.toast.info    { border-color: var(--gold);   color: var(--gold);  }

/* â”€â”€ Loading screen â”€â”€ */
#loading-screen {
  position: fixed; inset: 0; background: var(--bg);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  z-index: 10000; gap: 24px; transition: opacity 0.5s; padding: 32px;
}
.loading-logo { font-family: 'Cormorant Garamond', serif; font-size: 44px; font-weight: 300; color: var(--gold); letter-spacing: 0.1em; }
.loading-sub { font-size: 10px; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-dim); margin-top: -16px; }
.loading-bar-wrap { width: 200px; height: 2px; background: var(--border); border-radius: 2px; overflow: hidden; }
.loading-bar { height: 100%; background: var(--gold); width: 0%; transition: width 0.4s ease; box-shadow: 0 0 12px var(--gold); }
.loading-msg { font-size: 11px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-dim); text-align: center; }

/* â”€â”€ Install banner â”€â”€ */
#install-banner {
  display: none; position: fixed; top: 0; left: 0; right: 0;
  background: var(--gold); color: #0a0a0f;
  padding: 12px 16px; padding-top: calc(12px + var(--safe-top));
  font-size: 12px; letter-spacing: 0.05em;
  z-index: 9500; text-align: center;
  gap: 12px; align-items: center; justify-content: center;
}
#install-banner.show { display: flex; }
#install-banner button { background: #0a0a0f; color: var(--gold); border: none; border-radius: 6px; padding: 6px 14px; font-family: 'DM Mono', monospace; font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; }
</style>
</head>
<body>

<div id="loading-screen">
  <div class="loading-logo">FaceVault</div>
  <div class="loading-sub">Person Recognition</div>
  <div class="loading-bar-wrap"><div class="loading-bar" id="load-bar"></div></div>
  <div class="loading-msg" id="load-msg">Opening databaseâ€¦</div>
</div>

<div id="install-banner">
  <span>Install FaceVault as an app</span>
  <button onclick="installApp()">Install</button>
  <button onclick="dismissInstall()" style="background:transparent;color:#0a0a0f;border:none;font-size:18px;padding:0 4px;cursor:pointer;">âœ•</button>
</div>

<div class="app-shell">
  <header>
    <div class="logo">Face<span>Vault</span></div>
    <div class="status-pill">
      <div class="status-dot loading" id="status-dot"></div>
      <span id="status-text">Loading</span>
    </div>
  </header>

  <div class="content">

    <!-- REGISTER -->
    <div class="panel active" id="panel-register">
      <h1 class="panel-title">Register</h1>
      <p class="panel-sub">Capture multiple angles â†’ name â†’ save</p>
      <div class="db-badge"><strong>IndexedDB</strong> â€” stored locally, no expiry, works offline</div>

      <div class="mode-tabs">
        <button class="mode-tab active" id="reg-tab-camera" onclick="setRegMode('camera')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
          Camera
        </button>
        <button class="mode-tab" id="reg-tab-upload" onclick="setRegMode('upload')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg>
          Upload
        </button>
      </div>

      <!-- Camera mode -->
      <div id="reg-camera-mode">
        <div class="camera-wrap">
          <video id="reg-video" autoplay playsinline muted></video>
          <canvas id="reg-canvas" class="preview"></canvas>
          <div class="camera-overlay" id="reg-overlay"></div>
          <div class="face-badge" id="reg-badge">Face Detected</div>
          <button class="cam-flip" onclick="flipCamera('reg')" title="Flip camera">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6"/><path d="M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>
          </button>
        </div>
        <div class="controls">
          <button class="btn btn-ghost" onclick="startCamera('reg')">Start Camera</button>
          <button class="btn btn-primary" id="reg-capture-btn" onclick="captureShot()" disabled>Capture</button>
        </div>

        <!-- Multi-shot strip -->
        <div class="photo-strip-label">
          <span>Captured shots</span>
          <span class="strip-hint">2â€“5 angles for best accuracy</span>
        </div>
        <div class="photo-strip" id="reg-strip">
          <div class="strip-slot" id="slot-0"><span class="slot-num">1</span></div>
          <div class="strip-slot" id="slot-1"><span class="slot-num">2</span></div>
          <div class="strip-slot" id="slot-2"><span class="slot-num">3</span></div>
          <div class="strip-slot" id="slot-3"><span class="slot-num">4</span></div>
          <div class="strip-slot" id="slot-4"><span class="slot-num">5</span></div>
        </div>
        <div class="strip-progress" id="strip-progress"></div>
        <div class="capture-quality" id="capture-quality"></div>
      </div><!-- /reg-camera-mode -->

      <!-- Upload mode -->
      <div id="reg-upload-mode" style="display:none">
        <div class="upload-zone" id="reg-upload-zone"
             ondragover="handleDragOver(event,'reg-upload-zone')"
             ondragleave="handleDragLeave('reg-upload-zone')"
             ondrop="handleDrop(event,'reg')">
          <input type="file" id="reg-file-input" accept="image/*" onchange="handleFileSelect(event,'reg')" />
          <div class="upload-icon">ðŸ“·</div>
          <div class="upload-label">Tap to select photo</div>
          <div class="upload-sublabel">From camera roll, files, or drag & drop</div>
          <div class="upload-preview" id="reg-upload-preview">
            <img id="reg-upload-img" src="" alt="preview" />
            <div class="upload-preview-overlay">
              <span class="upload-preview-label" id="reg-upload-filename">photo.jpg</span>
            </div>
          </div>
        </div>
        <div class="controls">
          <button class="btn btn-ghost" onclick="clearUpload('reg')">Clear</button>
          <button class="btn btn-primary" id="reg-analyze-btn" onclick="analyzeUpload()" disabled>Analyze Face</button>
        </div>
      </div>

      <!-- Name input & duplicate warning -->
      <div class="duplicate-warn" id="duplicate-warn"></div>
      <div class="input-wrap" id="reg-name-wrap" style="display:none">
        <input type="text" id="reg-name-input" placeholder="Enter person's nameâ€¦" maxlength="60"
               onkeydown="if(event.key==='Enter') document.getElementById('reg-notes-input').focus()" />
      </div>
      <div class="notes-wrap" id="reg-notes-wrap" style="display:none">
        <textarea class="notes-input" id="reg-notes-input" placeholder="Notes (optional): context, where you met, roleâ€¦" maxlength="200"
                  onkeydown="if(event.key==='Enter'&&event.metaKey) savePerson()"></textarea>
        <div class="controls" style="margin-top:10px">
          <button class="btn btn-ghost" onclick="capturedShots=[];updateStrip();document.getElementById('reg-name-wrap').style.display='none';document.getElementById('reg-notes-wrap').style.display='none'">Reset</button>
          <button class="btn btn-primary" onclick="savePerson()">Save to Vault</button>
        </div>
      </div>
    </div>

    <!-- IDENTIFY -->
    <div class="panel" id="panel-recognize">
      <h1 class="panel-title">Identify</h1>
      <p class="panel-sub">Camera or upload â†’ match against vault</p>

      <div class="mode-tabs">
        <button class="mode-tab active" id="rec-tab-camera" onclick="setRecMode('camera')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
          Camera
        </button>
        <button class="mode-tab" id="rec-tab-upload" onclick="setRecMode('upload')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg>
          Upload
        </button>
      </div>

      <div id="rec-camera-mode">
        <div class="camera-wrap">
          <video id="rec-video" autoplay playsinline muted></video>
          <canvas id="rec-canvas" class="preview"></canvas>
          <div class="camera-overlay" id="rec-overlay"></div>
          <div class="face-badge" id="rec-badge">Face Detected</div>
          <button class="cam-flip" onclick="flipCamera('rec')" title="Flip camera">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6"/><path d="M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>
          </button>
        </div>
        <div class="controls">
          <button class="btn btn-ghost" onclick="startCamera('rec')">Start Camera</button>
          <button class="btn btn-primary" id="rec-identify-btn" onclick="identifyPerson()" disabled>Identify</button>
        </div>
        <div class="scan-progress" id="scan-progress">
          <div class="scan-label">Capturing frames for accuracyâ€¦</div>
          <div class="scan-dots">
            <div class="scan-dot" id="sdot-0"></div>
            <div class="scan-dot" id="sdot-1"></div>
            <div class="scan-dot" id="sdot-2"></div>
          </div>
        </div>
      </div>

      <div id="rec-upload-mode" style="display:none">
        <div class="upload-zone" id="rec-upload-zone"
             ondragover="handleDragOver(event,'rec-upload-zone')"
             ondragleave="handleDragLeave('rec-upload-zone')"
             ondrop="handleDrop(event,'rec')">
          <input type="file" id="rec-file-input" accept="image/*" onchange="handleFileSelect(event,'rec')" />
          <div class="upload-icon">ðŸ“·</div>
          <div class="upload-label">Tap to select photo</div>
          <div class="upload-sublabel">From camera roll, files, or drag & drop</div>
          <div class="upload-preview" id="rec-upload-preview">
            <img id="rec-upload-img" src="" alt="preview" />
            <div class="upload-preview-overlay">
              <span class="upload-preview-label" id="rec-upload-filename">photo.jpg</span>
            </div>
          </div>
        </div>
        <div class="controls">
          <button class="btn btn-ghost" onclick="clearUpload('rec')">Clear</button>
          <button class="btn btn-primary" id="rec-upload-identify-btn" onclick="identifyFromUpload()" disabled>Identify</button>
        </div>
      </div>

      <div class="result-card" id="result-card">
        <div class="result-header" id="result-header">Match Found</div>
        <div class="result-body">
          <img id="result-photo" class="result-photo" src="" alt="stored photo" />
          <div class="result-info">
            <h2 id="result-name">â€”</h2>
            <p id="result-meta">â€”</p>
            <span class="match-score" id="result-badge">â€”</span>
            <div class="distance-meter" id="distance-meter" style="display:none">
              <div class="distance-meter-label">
                <span>Similarity</span>
                <span id="distance-pct">â€”</span>
              </div>
              <div class="distance-bar-track">
                <div class="distance-bar-fill" id="distance-bar" style="width:0%"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="closest-hint" id="closest-hint"></div>
        <div style="padding:0 16px 14px;display:none" id="result-notes-wrap">
          <p id="result-notes" style="font-size:11px;color:var(--text-dim);letter-spacing:0.04em;line-height:1.6"></p>
        </div>
      </div>
    </div>

    <!-- VAULT -->
    <div class="panel" id="panel-gallery">
      <div class="gallery-header">
        <h1 class="gallery-title">Vault</h1>
        <div class="gallery-controls">
          <span class="count-badge" id="gallery-count">0 persons</span>
          <button class="btn-sm" onclick="clearAllPersons()">Clear All</button>
        </div>
      </div>
      <div class="vault-actions">
        <button class="btn-icon" onclick="exportVault()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Export Backup
        </button>
        <button class="btn-icon" onclick="document.getElementById('import-file').click()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          Import Backup
        </button>
        <input type="file" id="import-file" accept=".json" style="display:none" onchange="importVault(event)" />
      </div>
      <div class="gallery-grid" id="gallery-grid"></div>
    </div>

  </div><!-- /content -->

  <nav class="bottom-nav">
    <button class="bottom-nav-btn active" id="nav-register" onclick="switchPanel('register')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="8" r="4"/><path d="M20 21a8 8 0 1 0-16 0"/><line x1="12" y1="15" x2="12" y2="21"/><line x1="9" y1="18" x2="15" y2="18"/></svg>
      <span>Register</span>
    </button>
    <button class="bottom-nav-btn" id="nav-recognize" onclick="switchPanel('recognize')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/><circle cx="11" cy="9" r="2"/><path d="M7 18c0-2.5 1.8-4 4-4s4 1.5 4 4"/></svg>
      <span>Identify</span>
    </button>
    <button class="bottom-nav-btn" id="nav-gallery" onclick="switchPanel('gallery')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      <span>Vault</span>
    </button>
  </nav>
</div>

<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<script>
// â”€â”€ IndexedDB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DB_NAME = 'FaceVaultDB2', DB_VER = 1, STORE = 'persons';
let db = null;

function openDB() {
  return new Promise((res, rej) => {
    const r = indexedDB.open(DB_NAME, DB_VER);
    r.onupgradeneeded = e => {
      if (!e.target.result.objectStoreNames.contains(STORE))
        e.target.result.createObjectStore(STORE, { keyPath: 'id' });
    };
    r.onsuccess = e => { db = e.target.result; res(); };
    r.onerror   = e => rej(e.target.error);
  });
}
const tx       = m  => db.transaction(STORE, m).objectStore(STORE);
const dbGetAll = () => new Promise((r,j) => { const q=tx('readonly').getAll();   q.onsuccess=()=>r(q.result); q.onerror=()=>j(q.error); });
const dbPut    = o  => new Promise((r,j) => { const q=tx('readwrite').put(o);    q.onsuccess=()=>r();         q.onerror=()=>j(q.error); });
const dbDelete = id => new Promise((r,j) => { const q=tx('readwrite').delete(id);q.onsuccess=()=>r();         q.onerror=()=>j(q.error); });
const dbClear  = () => new Promise((r,j) => { const q=tx('readwrite').clear();   q.onsuccess=()=>r();         q.onerror=()=>j(q.error); });

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MODEL_URL   = 'https://justadudewhohacks.github.io/face-api.js/models';
const MAX_SHOTS   = 5;
const MATCH_THRESHOLD = 0.42;
const DUP_THRESHOLD   = 0.38;

let modelsReady   = false;
let highAccuracy  = false;   // true if SSD + full landmarks loaded successfully
let capturedShots = [];         // [{descriptor, photoDataUrl, score}]
let detectionLoops = {};
let loopLastTs = {};            // for RAF throttling
let regUploadDataUrl = null, recUploadDataUrl = null;
let facingModes  = { reg: 'user', rec: 'user' };
let activeStreams = {};
let currentPanel = 'register';

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  const bar = document.getElementById('load-bar');
  const msg = document.getElementById('load-msg');

  // Step 1: Core models â€” required, no fallback
  const coreSteps = [
    { pct: 10, label: 'Opening databaseâ€¦',         fn: openDB },
    { pct: 30, label: 'Loading face detectorâ€¦',    fn: () => faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL) },
    { pct: 55, label: 'Loading landmark modelâ€¦',   fn: () => faceapi.nets.faceLandmark68TinyNet.loadFromUri(MODEL_URL) },
    { pct: 75, label: 'Loading recognition netâ€¦',  fn: () => faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL) },
  ];
  for (const s of coreSteps) {
    msg.textContent = s.label; bar.style.width = s.pct + '%';
    await s.fn();
  }

  // Step 2: High-accuracy models â€” optional, fallback gracefully if they fail
  try {
    msg.textContent = 'Loading HD modelsâ€¦'; bar.style.width = '85%';
    await faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL);
    await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
    highAccuracy = true;
  } catch(e) {
    console.warn('HD models failed to load, falling back to standard models:', e);
    highAccuracy = false;
  }

  bar.style.width = '100%';
  msg.textContent = highAccuracy ? 'Ready! (HD mode)' : 'Ready!';
  modelsReady = true;

  setTimeout(() => {
    const ls = document.getElementById('loading-screen');
    ls.style.opacity = '0';
    setTimeout(() => ls.style.display = 'none', 500);
  }, 300);
  document.getElementById('status-dot').className    = 'status-dot ready';
  document.getElementById('status-text').textContent = highAccuracy ? 'HD Ready' : 'Ready';
}

// â”€â”€ Visibility â€” pause loops when tab is hidden â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('visibilitychange', () => {
  if (document.hidden) pauseAllLoops();
  else if (!document.hidden && activeStreams[currentPanel === 'register' ? 'reg' : 'rec']) {
    startDetectionLoop(currentPanel === 'register' ? 'reg' : 'rec');
  }
});

function pauseAllLoops() {
  Object.keys(detectionLoops).forEach(mode => {
    if (detectionLoops[mode]) { cancelAnimationFrame(detectionLoops[mode]); detectionLoops[mode] = null; }
  });
}

// â”€â”€ Camera â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startCamera(mode) {
  if (activeStreams[mode]) {
    activeStreams[mode].getTracks().forEach(t => t.stop());
    activeStreams[mode] = null;
  }
  if (detectionLoops[mode]) { cancelAnimationFrame(detectionLoops[mode]); detectionLoops[mode] = null; }

  const video = document.getElementById(mode + '-video');
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: facingModes[mode], width: { ideal: 1280 }, height: { ideal: 960 } },
      audio: false
    });
    activeStreams[mode] = stream;
    video.srcObject = stream;
    await new Promise(r => (video.onloadedmetadata = r));
    startDetectionLoop(mode);
    document.getElementById(mode === 'reg' ? 'reg-capture-btn' : 'rec-identify-btn').disabled = false;
    showToast('Camera started', 'success');
  } catch(e) {
    showToast('Camera error: ' + (e.message || 'access denied'), 'error');
  }
}

async function flipCamera(mode) {
  facingModes[mode] = facingModes[mode] === 'user' ? 'environment' : 'user';
  const video = document.getElementById(mode + '-video');
  if (video.srcObject) await startCamera(mode);
}

function stopCamera(mode) {
  if (activeStreams[mode]) {
    activeStreams[mode].getTracks().forEach(t => t.stop());
    activeStreams[mode] = null;
  }
  if (detectionLoops[mode]) { cancelAnimationFrame(detectionLoops[mode]); detectionLoops[mode] = null; }
  const video = document.getElementById(mode + '-video');
  if (video) video.srcObject = null;
}

// IMPROVED: throttle loop to ~5fps for detection â€” saves battery, same visual quality
function startDetectionLoop(mode) {
  const video   = document.getElementById(mode + '-video');
  const canvas  = document.getElementById(mode + '-canvas');
  const overlay = document.getElementById(mode + '-overlay');
  const badge   = document.getElementById(mode + '-badge');
  loopLastTs[mode] = 0;

  async function loop(ts) {
    if (!modelsReady || video.paused || video.ended || !video.srcObject || document.hidden) {
      detectionLoops[mode] = requestAnimationFrame(loop); return;
    }
    // Throttle: only run detection every 200ms (~5fps) â€” big CPU/battery saving
    if (ts - (loopLastTs[mode] || 0) < 200) {
      detectionLoops[mode] = requestAnimationFrame(loop); return;
    }
    loopLastTs[mode] = ts;

    const size = { width: video.videoWidth || 640, height: video.videoHeight || 480 };
    faceapi.matchDimensions(canvas, size);
    const dets = await faceapi
      .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.5 }))
      .withFaceLandmarks(true);

    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (dets.length > 0) {
      faceapi.resizeResults(dets, size).forEach(d => {
        const b = d.detection.box;
        ctx.strokeStyle = '#c9a84c'; ctx.lineWidth = 2;
        ctx.strokeRect(b.x, b.y, b.width, b.height);
        const cs = 14; ctx.strokeStyle = '#e8c97a'; ctx.lineWidth = 3;
        [[b.x,b.y,cs,cs],[b.x+b.width,b.y,-cs,cs],[b.x,b.y+b.height,cs,-cs],[b.x+b.width,b.y+b.height,-cs,-cs]]
          .forEach(([cx,cy,dx,dy]) => {
            ctx.beginPath(); ctx.moveTo(cx+dx,cy); ctx.lineTo(cx,cy); ctx.lineTo(cx,cy+dy); ctx.stroke();
          });
      });
      overlay.classList.add('detected'); badge.classList.add('visible');
    } else {
      overlay.classList.remove('detected'); badge.classList.remove('visible');
    }
    detectionLoops[mode] = requestAnimationFrame(loop);
  }
  detectionLoops[mode] = requestAnimationFrame(loop);
}

// â”€â”€ Multi-shot capture (IMPROVED: uses SSD + full landmarks) â”€â”€â”€â”€â”€â”€
function updateStrip() {
  const progress = document.getElementById('strip-progress');
  const qualEl   = document.getElementById('capture-quality');
  for (let i = 0; i < MAX_SHOTS; i++) {
    const slot = document.getElementById('slot-' + i);
    if (capturedShots[i]) {
      slot.innerHTML = `<img src="${capturedShots[i].photoDataUrl}" /><button class="slot-del" onclick="removeShot(${i})">âœ•</button>`;
      slot.classList.add('filled');
    } else {
      slot.innerHTML = `<span class="slot-num">${i+1}</span>`;
      slot.classList.remove('filled');
    }
  }
  const n = capturedShots.length;

  // Quality indicator: average detection score
  if (n > 0) {
    const avgScore = capturedShots.reduce((sum, s) => sum + (s.score || 0.7), 0) / n;
    const cls = avgScore >= 0.85 ? 'good' : avgScore >= 0.7 ? 'ok' : 'bad';
    const label = avgScore >= 0.85 ? 'Good quality' : avgScore >= 0.7 ? 'Acceptable quality' : 'Low quality â€” try better lighting';
    qualEl.innerHTML = `<div class="quality-dot ${cls}"></div><span style="color:var(--text-dim)">${label} (avg confidence ${Math.round(avgScore*100)}%)</span>`;
  } else {
    qualEl.innerHTML = '';
  }

  if (n === 0) {
    progress.textContent = '';
    document.getElementById('reg-name-wrap').style.display = 'none';
    document.getElementById('reg-notes-wrap').style.display = 'none';
    document.getElementById('duplicate-warn').classList.remove('show');
  } else {
    progress.textContent = `${n} shot${n>1?'s':''} captured${n >= 2 ? ' â€” ready to save' : ' â€” capture more for better accuracy'}`;
    if (n >= 2) {
      document.getElementById('reg-name-wrap').style.display = 'flex';
      document.getElementById('reg-notes-wrap').style.display = 'block';
      document.getElementById('reg-name-input').focus();
    }
  }
}

function removeShot(i) {
  capturedShots.splice(i, 1);
  updateStrip();
}

// IMPROVED: use SSD Mobilenet + full landmark model for high-quality descriptors
async function captureShot() {
  if (capturedShots.length >= MAX_SHOTS) { showToast(`Maximum ${MAX_SHOTS} shots reached`, 'info'); return; }
  const video = document.getElementById('reg-video');
  if (!video.srcObject) { showToast('Start the camera first', 'info'); return; }

  showToast('Analyzingâ€¦', 'info');
  const result = await faceapi
    .detectSingleFace(video, highAccuracy
      ? new faceapi.SsdMobilenetv1Options({ minConfidence: 0.5 })
      : new faceapi.TinyFaceDetectorOptions({ inputSize: 416, scoreThreshold: 0.4 }))
    .withFaceLandmarks(highAccuracy ? false : true)
    .withFaceDescriptor();
  if (!result) { showToast('No face detected â€” center your face in good light', 'error'); return; }

  const score = result.detection.score;

  // Crop face photo
  const b = result.detection.box, pad = 40;
  const tmp = document.createElement('canvas');
  tmp.width  = Math.min(b.width+pad*2,  video.videoWidth);
  tmp.height = Math.min(b.height+pad*2, video.videoHeight);
  tmp.getContext('2d').drawImage(video, Math.max(0,b.x-pad), Math.max(0,b.y-pad), tmp.width, tmp.height, 0, 0, tmp.width, tmp.height);
  const photoDataUrl = tmp.toDataURL('image/jpeg', 0.88);

  capturedShots.push({ descriptor: Array.from(result.descriptor), photoDataUrl, score });
  updateStrip();
  showToast(`Shot ${capturedShots.length} captured! (confidence: ${Math.round(score*100)}%)`, 'success');
}

// â”€â”€ Duplicate check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkDuplicate(descriptors) {
  const all = await dbGetAll();
  if (!all.length) return null;
  let bestPerson = null, bestDist = Infinity;
  for (const p of all) {
    const pDescriptors = p.descriptors.map(d => new Float32Array(d));
    for (const qDesc of descriptors) {
      const minDist = Math.min(...pDescriptors.map(d => faceapi.euclideanDistance(qDesc, d)));
      if (minDist < bestDist) { bestDist = minDist; bestPerson = p; }
    }
  }
  return bestDist < DUP_THRESHOLD ? { person: bestPerson, dist: bestDist } : null;
}

// â”€â”€ Save person â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function savePerson() {
  const name  = document.getElementById('reg-name-input').value.trim();
  const notes = document.getElementById('reg-notes-input').value.trim();
  if (!name)                      { showToast('Please enter a name', 'error');        return; }
  if (capturedShots.length === 0) { showToast('Capture at least one shot', 'error'); return; }

  const dup = await checkDuplicate(capturedShots.map(s => s.descriptor));
  const warn = document.getElementById('duplicate-warn');
  if (dup) {
    warn.innerHTML = `âš  This face looks similar to <strong>${dup.person.name}</strong> already in the vault (${Math.round((1-dup.dist)*100)}% match). Save anyway?`;
    warn.classList.add('show');
    if (!warn.dataset.confirmed) { warn.dataset.confirmed = '1'; return; }
  }
  warn.classList.remove('show');
  warn.dataset.confirmed = '';

  const descriptors  = capturedShots.map(s => s.descriptor);
  const photoDataUrl = capturedShots[0].photoDataUrl;

  await dbPut({
    id: Date.now().toString(), name, notes,
    photoDataUrl,
    descriptors,
    shotCount: capturedShots.length,
    avgScore: capturedShots.reduce((s,c) => s + (c.score||0.7), 0) / capturedShots.length,
    date: new Date().toLocaleDateString()
  });

  showToast(`âœ“ ${name} saved with ${capturedShots.length} shot${capturedShots.length>1?'s':''}`, 'success');
  document.getElementById('reg-name-input').value  = '';
  document.getElementById('reg-notes-input').value = '';
  capturedShots = [];
  updateStrip();
}

// â”€â”€ Matching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function findBestMatch(queryDescriptor) {
  const all = await dbGetAll();
  if (!all.length) return { person: null, dist: Infinity };
  const labeled = all.map(p => new faceapi.LabeledFaceDescriptors(
    p.id,
    (p.descriptors || [p.descriptor]).map(d => new Float32Array(d))
  ));
  const matcher = new faceapi.FaceMatcher(labeled, MATCH_THRESHOLD);
  const match   = matcher.findBestMatch(queryDescriptor);
  const person  = all.find(p => p.id === match.label) || null;

  // Also find the closest person regardless of threshold (for "closest hint")
  let closestPerson = null, closestDist = Infinity;
  for (const p of all) {
    const descs = (p.descriptors || [p.descriptor]).map(d => new Float32Array(d));
    const minD  = Math.min(...descs.map(d => faceapi.euclideanDistance(queryDescriptor, d)));
    if (minD < closestDist) { closestDist = minD; closestPerson = p; }
  }

  return { person, dist: match.distance, closestPerson, closestDist };
}

// â”€â”€ Show result â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showResult(person, distance, closestPerson, closestDist) {
  const card = document.getElementById('result-card');
  card.classList.add('show');
  const meter = document.getElementById('distance-meter');
  meter.style.display = 'block';
  const hint = document.getElementById('closest-hint');

  if (person && distance < MATCH_THRESHOLD) {
    document.getElementById('result-header').textContent = 'Match Found';
    document.getElementById('result-name').textContent   = person.name;
    document.getElementById('result-photo').src          = person.photoDataUrl;
    document.getElementById('result-meta').textContent   =
      `${person.shotCount || 1} reference shot${(person.shotCount||1)>1?'s':''} Â· Registered: ${person.date}`;

    // Show notes if present
    const notesWrap = document.getElementById('result-notes-wrap');
    const notesEl   = document.getElementById('result-notes');
    if (person.notes) {
      notesEl.textContent = 'ðŸ“ ' + person.notes;
      notesWrap.style.display = 'block';
    } else {
      notesWrap.style.display = 'none';
    }

    const simPct  = Math.round((1 - distance) * 100);
    const barPct  = Math.max(0, Math.min(100, simPct));
    document.getElementById('distance-pct').textContent = simPct + '%';
    document.getElementById('distance-bar').style.width      = barPct + '%';
    document.getElementById('distance-bar').style.background = distance < 0.35 ? 'var(--green)' : 'var(--gold)';

    const b = document.getElementById('result-badge');
    b.textContent = distance < 0.35 ? 'High Confidence' : 'Likely Match';
    b.className   = 'match-score ' + (distance < 0.35 ? 'high' : 'low');
    hint.classList.remove('show');
    showToast(`Identified: ${person.name}`, 'success');
  } else {
    document.getElementById('result-header').textContent = 'No Match Found';
    document.getElementById('result-name').textContent   = 'Unknown Person';
    document.getElementById('result-photo').src          = 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 80 80"><rect width="80" height="80" fill="#1c1c28"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-size="32" fill="#7a7870">?</text></svg>');
    document.getElementById('result-meta').textContent   = 'Not in vault â€” register this person first';
    document.getElementById('result-notes-wrap').style.display = 'none';
    document.getElementById('distance-pct').textContent = '0%';
    document.getElementById('distance-bar').style.width  = '0%';
    const b = document.getElementById('result-badge');
    b.textContent = 'Unknown'; b.className = 'match-score none';

    // Show closest hint so user knows how far off the nearest entry was
    if (closestPerson && closestDist < 0.7) {
      hint.innerHTML = `Closest in vault: <strong>${closestPerson.name}</strong> â€” ${Math.round((1-closestDist)*100)}% similarity (below match threshold)`;
      hint.classList.add('show');
    } else {
      hint.classList.remove('show');
    }

    showToast('Person not found in vault', 'error');
  }
}

// â”€â”€ Identify (camera) â€” IMPROVED: multi-frame averaging â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function identifyPerson() {
  const video = document.getElementById('rec-video');
  if (!video.srcObject) { showToast('Start the camera first', 'info'); return; }
  const all = await dbGetAll();
  if (!all.length) { showToast('Vault is empty â€” register someone first', 'info'); return; }

  // Show scanning indicator
  const scanEl  = document.getElementById('scan-progress');
  const dots    = [document.getElementById('sdot-0'), document.getElementById('sdot-1'), document.getElementById('sdot-2')];
  const btn     = document.getElementById('rec-identify-btn');
  btn.disabled = true;
  scanEl.classList.add('show');
  dots.forEach(d => { d.className = 'scan-dot'; });

  // Capture 3 frames 350ms apart, use SSD + full landmarks for quality
  const descriptors = [];
  for (let i = 0; i < 3; i++) {
    dots[i].classList.add('active');
    await new Promise(r => setTimeout(r, i === 0 ? 0 : 350));
    const result = await faceapi
      .detectSingleFace(video, highAccuracy
        ? new faceapi.SsdMobilenetv1Options({ minConfidence: 0.45 })
        : new faceapi.TinyFaceDetectorOptions({ inputSize: 416, scoreThreshold: 0.4 }))
      .withFaceLandmarks(highAccuracy ? false : true)
      .withFaceDescriptor();
    if (result) {
      descriptors.push({ descriptor: result.descriptor, score: result.detection.score });
    }
    dots[i].classList.remove('active');
    dots[i].classList.add('done');
  }

  btn.disabled = false;
  scanEl.classList.remove('show');

  if (!descriptors.length) { showToast('No face detected in any frame â€” center your face', 'error'); return; }

  // Average the descriptors for a more stable query
  let queryDescriptor;
  if (descriptors.length === 1) {
    queryDescriptor = descriptors[0].descriptor;
  } else {
    // Weighted average by detection confidence score
    const totalScore = descriptors.reduce((s, d) => s + d.score, 0);
    const avg = new Float32Array(128);
    for (const {descriptor, score} of descriptors) {
      const w = score / totalScore;
      for (let j = 0; j < 128; j++) avg[j] += descriptor[j] * w;
    }
    queryDescriptor = avg;
  }

  const { person, dist, closestPerson, closestDist } = await findBestMatch(queryDescriptor);
  showResult(person, dist, closestPerson, closestDist);
}

// â”€â”€ Upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setRegMode(m) {
  const c = m === 'camera';
  document.getElementById('reg-camera-mode').style.display = c ? '' : 'none';
  document.getElementById('reg-upload-mode').style.display = c ? 'none' : '';
  document.getElementById('reg-tab-camera').classList.toggle('active', c);
  document.getElementById('reg-tab-upload').classList.toggle('active', !c);
  document.getElementById('reg-name-wrap').style.display = 'none';
  document.getElementById('reg-notes-wrap').style.display = 'none';
  document.getElementById('duplicate-warn').classList.remove('show');
  if (!c) { capturedShots = []; updateStrip(); }
}

function setRecMode(m) {
  const c = m === 'camera';
  document.getElementById('rec-camera-mode').style.display = c ? '' : 'none';
  document.getElementById('rec-upload-mode').style.display = c ? 'none' : '';
  document.getElementById('rec-tab-camera').classList.toggle('active', c);
  document.getElementById('rec-tab-upload').classList.toggle('active', !c);
  document.getElementById('result-card').classList.remove('show');
}

function handleDragOver(e, id) { e.preventDefault(); document.getElementById(id).classList.add('drag-over'); }
function handleDragLeave(id)   { document.getElementById(id).classList.remove('drag-over'); }
function handleDrop(e, prefix) {
  e.preventDefault();
  document.getElementById(prefix+'-upload-zone').classList.remove('drag-over');
  const f = e.dataTransfer.files[0];
  if (f && f.type.startsWith('image/')) loadUploadedFile(f, prefix);
  else showToast('Please drop an image file', 'error');
}
function handleFileSelect(e, prefix) { const f = e.target.files[0]; if (f) loadUploadedFile(f, prefix); }

function loadUploadedFile(file, prefix) {
  const reader = new FileReader();
  reader.onload = e => {
    const url = e.target.result;
    document.getElementById(prefix+'-upload-img').src = url;
    document.getElementById(prefix+'-upload-filename').textContent = file.name;
    document.getElementById(prefix+'-upload-preview').classList.add('show');
    if (prefix === 'reg') { regUploadDataUrl = url; document.getElementById('reg-analyze-btn').disabled = false; }
    else                  { recUploadDataUrl = url; document.getElementById('rec-upload-identify-btn').disabled = false; }
  };
  reader.readAsDataURL(file);
}

function clearUpload(prefix) {
  document.getElementById(prefix+'-upload-img').src = '';
  document.getElementById(prefix+'-upload-preview').classList.remove('show');
  document.getElementById(prefix+'-file-input').value = '';
  if (prefix === 'reg') {
    regUploadDataUrl = null;
    document.getElementById('reg-analyze-btn').disabled = true;
    document.getElementById('reg-name-wrap').style.display = 'none';
    document.getElementById('reg-notes-wrap').style.display = 'none';
    document.getElementById('duplicate-warn').classList.remove('show');
    capturedShots = [];
  } else {
    recUploadDataUrl = null;
    document.getElementById('rec-upload-identify-btn').disabled = true;
    document.getElementById('result-card').classList.remove('show');
  }
}

// IMPROVED: SSD + full landmarks for upload analyze
async function analyzeUpload() {
  if (!regUploadDataUrl) { showToast('Upload a photo first', 'info'); return; }
  showToast('Analyzing face in photoâ€¦', 'info');
  const img = await loadImg(regUploadDataUrl);
  const result = await faceapi
    .detectSingleFace(img, highAccuracy
      ? new faceapi.SsdMobilenetv1Options({ minConfidence: 0.4 })
      : new faceapi.TinyFaceDetectorOptions({ inputSize: 416, scoreThreshold: 0.3 }))
    .withFaceLandmarks(highAccuracy ? false : true)
    .withFaceDescriptor();
  if (!result) { showToast('No face detected â€” try a clearer front-facing photo', 'error'); return; }

  const score = result.detection.score;
  const b = result.detection.box, pad = 40;
  const tmp = document.createElement('canvas');
  tmp.width  = Math.min(b.width+pad*2,  img.naturalWidth);
  tmp.height = Math.min(b.height+pad*2, img.naturalHeight);
  tmp.getContext('2d').drawImage(img, Math.max(0,b.x-pad), Math.max(0,b.y-pad), tmp.width, tmp.height, 0, 0, tmp.width, tmp.height);
  const photoDataUrl = tmp.toDataURL('image/jpeg', 0.88);

  capturedShots = [{ descriptor: Array.from(result.descriptor), photoDataUrl, score }];
  updateStrip();
  showToast(`Face found! Confidence: ${Math.round(score*100)}% â€” enter a name to save`, 'info');
  document.getElementById('reg-name-wrap').style.display = 'flex';
  document.getElementById('reg-notes-wrap').style.display = 'block';
  document.getElementById('reg-name-input').focus();
}

// IMPROVED: SSD + full landmarks for upload identify
async function identifyFromUpload() {
  if (!recUploadDataUrl) { showToast('Upload a photo first', 'info'); return; }
  const all = await dbGetAll();
  if (!all.length) { showToast('Vault is empty â€” register someone first', 'info'); return; }
  showToast('Scanning uploaded photoâ€¦', 'info');
  const img = await loadImg(recUploadDataUrl);
  const result = await faceapi
    .detectSingleFace(img, highAccuracy
      ? new faceapi.SsdMobilenetv1Options({ minConfidence: 0.4 })
      : new faceapi.TinyFaceDetectorOptions({ inputSize: 416, scoreThreshold: 0.3 }))
    .withFaceLandmarks(highAccuracy ? false : true)
    .withFaceDescriptor();
  if (!result) { showToast('No face detected â€” try a clearer photo', 'error'); return; }
  const { person, dist, closestPerson, closestDist } = await findBestMatch(result.descriptor);
  showResult(person, dist, closestPerson, closestDist);
}

function loadImg(src) {
  return new Promise((res, rej) => { const i = new Image(); i.onload = () => res(i); i.onerror = rej; i.src = src; });
}

// â”€â”€ Export / Import Vault â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function exportVault() {
  const all = await dbGetAll();
  if (!all.length) { showToast('Vault is empty â€” nothing to export', 'info'); return; }
  const json = JSON.stringify({ version: 2, exported: new Date().toISOString(), persons: all }, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = `facevault-backup-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast(`Exported ${all.length} person${all.length!==1?'s':''}`, 'success');
}

async function importVault(event) {
  const file = event.target.files[0];
  if (!file) return;
  event.target.value = '';
  try {
    const text = await file.text();
    const data = JSON.parse(text);
    if (!data.persons || !Array.isArray(data.persons)) throw new Error('Invalid backup format');
    const existing = await dbGetAll();
    const existingIds = new Set(existing.map(p => p.id));
    let added = 0;
    for (const p of data.persons) {
      if (!existingIds.has(p.id)) { await dbPut(p); added++; }
    }
    showToast(`Imported ${added} new person${added!==1?'s':''} (${data.persons.length - added} already existed)`, 'success');
    renderGallery();
  } catch(e) {
    showToast('Import failed: ' + e.message, 'error');
  }
}

// â”€â”€ Gallery â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderGallery() {
  const all  = await dbGetAll();
  const grid = document.getElementById('gallery-grid');
  document.getElementById('gallery-count').textContent = `${all.length} person${all.length!==1?'s':''}`;
  if (!all.length) {
    grid.innerHTML = `<div class="empty-state"><div class="icon">ðŸ”</div><p>Your vault is empty.<br>Register a person to get started.</p></div>`;
    return;
  }
  grid.innerHTML = all.map(p => `
    <div class="gallery-card">
      <img src="${p.photoDataUrl}" alt="${p.name}" loading="lazy" />
      <button class="gallery-card-del" onclick="deletePerson('${p.id}')">âœ•</button>
      <div class="gallery-card-info">
        <div class="gallery-card-name">${p.name}</div>
        <div class="gallery-card-date">${p.date}</div>
        <div class="gallery-card-shots">${p.shotCount || 1} shot${(p.shotCount||1)>1?'s':''}${p.notes ? ' Â· ðŸ“' : ''}</div>
      </div>
    </div>`).join('');
}

async function deletePerson(id) { await dbDelete(id); showToast('Removed from vault', 'info'); renderGallery(); }
async function clearAllPersons() {
  if (!confirm('Delete ALL persons? This cannot be undone.')) return;
  await dbClear(); showToast('Vault cleared', 'info'); renderGallery();
}

// â”€â”€ Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchPanel(name) {
  const modeForPanel = { register: 'reg', recognize: 'rec' };
  Object.entries(modeForPanel).forEach(([panel, mode]) => {
    if (panel !== name) stopCamera(mode);
  });
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.bottom-nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
  document.getElementById('nav-' + name).classList.add('active');
  currentPanel = name;
  if (name === 'gallery')   renderGallery();
  if (name === 'recognize') document.getElementById('result-card').classList.remove('show');
}

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let toastTimer;
function showToast(msg, type = 'info') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = `toast show ${type}`;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3000);
}

// â”€â”€ PWA Install â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault(); deferredPrompt = e;
  document.getElementById('install-banner').classList.add('show');
});
async function installApp() {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  deferredPrompt = null;
  document.getElementById('install-banner').classList.remove('show');
  if (outcome === 'accepted') showToast('FaceVault installed!', 'success');
}
function dismissInstall() { document.getElementById('install-banner').classList.remove('show'); }

// â”€â”€ Service Worker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(e => console.warn('SW reg failed:', e));
}

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init().catch(e => {
  document.getElementById('load-msg').textContent = 'Error â€” check internet connection';
  console.error(e);
});
</script>
</body>
</html>
